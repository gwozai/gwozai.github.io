<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½éšæœºå›¾ç‰‡æµè§ˆå™¨</title>
    <!-- desc: ç²¾ç¾çš„è‡ªåŠ¨åŠ è½½éšæœºå›¾ç‰‡æµè§ˆå™¨ï¼Œæ”¯æŒç€‘å¸ƒæµå±•ç¤ºå’Œæ™ºèƒ½è½®æ’­ -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- PhotoSwipe CSS -->
    <link href="https://cdn.jsdelivr.net/npm/photoswipe@5.4.2/dist/photoswipe.css" rel="stylesheet">
    <!-- AOS Animation CSS -->
    <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
            position: relative;
            transition: all 0.5s ease;
        }

        /* åŠ¨æ€èƒŒæ™¯å±‚ */
        .background-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0;
            transition: opacity 0.8s ease;
        }

        .background-layer.active {
            opacity: 1;
        }

        /* èƒŒæ™¯é®ç½©å±‚ */
        .background-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(2px);
            transition: all 0.5s ease;
        }

        /* æ— èƒŒæ™¯æ¨¡å¼ */
        body.no-background {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        }

        body.no-background .background-overlay {
            opacity: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: clamp(2rem, 4vw, 3.5rem);
            font-weight: 700;
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header p {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 20px;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
            color: rgba(255, 255, 255, 0.9);
        }

        .stat-number {
            display: block;
            font-size: 2rem;
            font-weight: bold;
            color: #fff;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .control-btn.active {
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .image-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.4s ease;
            opacity: 0;
            transform: translateY(20px);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .image-card.loaded {
            opacity: 1;
            transform: translateY(0);
        }

        .image-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
        }

        .image-card.error {
            border: 2px solid #e74c3c;
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
        }

        .image-card.retrying {
            border: 2px solid #f39c12;
            background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
        }

        .error-placeholder {
            width: 100%;
            height: 300px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            border-radius: 12px;
            border: 2px dashed #dee2e6;
        }

        .error-placeholder i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .error-placeholder .error-message {
            font-size: 1rem;
            margin-bottom: 10px;
            text-align: center;
        }

        .retry-button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .retry-button:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        .retry-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .image-wrapper {
            position: relative;
            overflow: hidden;
            height: 300px;
        }

        .image-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.4s ease;
        }

        .image-card:hover img {
            transform: scale(1.05);
        }

        .image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, transparent 0%, rgba(0, 0, 0, 0.7) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            display: flex;
            align-items: flex-end;
            padding: 20px;
        }

        .image-card:hover .image-overlay {
            opacity: 1;
        }

        .image-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .action-btn:hover {
            background: white;
            transform: translateY(-2px);
        }

        .image-info {
            padding: 20px;
            text-align: center;
        }

        .image-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .image-source {
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 20px;
            height: 400px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .load-more-section {
            text-align: center;
            margin: 40px 0;
        }

        .load-more-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .load-more-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
        }

        .load-more-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .auto-load-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            background: rgba(46, 204, 113, 0.9);
            color: white;
            border-radius: 25px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1000;
            display: none;
            backdrop-filter: blur(10px);
        }

        .auto-load-indicator.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            backdrop-filter: blur(10px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            max-width: 90vw;
            max-height: 90vh;
            position: relative;
        }

        .modal img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 10px;
        }

        .modal-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* èƒŒæ™¯è®¾ç½®é¢æ¿ */
        .background-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            width: 400px;
            max-width: 90vw;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            z-index: 3000;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.3);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .background-panel.show {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .background-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .background-panel-header h3 {
            color: #333;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .close-panel {
            background: none;
            border: none;
            font-size: 24px;
            color: #666;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-panel:hover {
            background: rgba(0, 0, 0, 0.1);
            color: #333;
        }

        .background-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .background-option {
            text-align: center;
            cursor: pointer;
            padding: 15px 10px;
            border-radius: 12px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .background-option:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .background-option.active {
            background: rgba(102, 126, 234, 0.15);
            border-color: #667eea;
        }

        .option-preview {
            width: 60px;
            height: 40px;
            border-radius: 8px;
            margin: 0 auto 8px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #667eea;
        }

        .gradient-preview {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        }

        .bing-preview, .gallery-preview {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
        }

        .background-option span {
            font-size: 0.85rem;
            color: #333;
            font-weight: 500;
        }

        .background-controls {
            space-y: 15px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            font-size: 0.9rem;
            color: #333;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .control-group input[type="range"] {
            width: 100%;
            margin-right: 10px;
            accent-color: #667eea;
        }

        .control-group span {
            font-size: 0.85rem;
            color: #666;
            font-weight: 500;
            float: right;
        }

        /* èƒŒæ™¯é¢æ¿é®ç½© */
        .panel-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2500;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .panel-backdrop.show {
            opacity: 1;
            visibility: visible;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .gallery {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px;
            }

            .controls {
                gap: 10px;
            }

            .control-btn {
                padding: 10px 16px;
                font-size: 12px;
            }

            .stats {
                gap: 20px;
            }

            .stat-number {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .gallery {
                grid-template-columns: 1fr;
            }

            .header {
                padding: 20px;
            }

            .controls {
                flex-direction: column;
                align-items: center;
            }

            .control-btn {
                width: 200px;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- åŠ¨æ€èƒŒæ™¯å±‚ -->
    <div class="background-layer" id="backgroundLayer"></div>
    <div class="background-overlay" id="backgroundOverlay"></div>

    <!-- é¢æ¿é®ç½© -->
    <div class="panel-backdrop" id="panelBackdrop"></div>

    <!-- èƒŒæ™¯è®¾ç½®é¢æ¿ -->
    <div class="background-panel" id="backgroundPanel">
        <div class="background-panel-header">
            <h3><i class="fas fa-palette"></i> èƒŒæ™¯è®¾ç½®</h3>
            <button class="close-panel" id="closePanelBtn">&times;</button>
        </div>
        <div class="background-options">
            <div class="background-option active" data-type="none">
                <div class="option-preview gradient-preview"></div>
                <span>é»˜è®¤æ¸å˜</span>
            </div>
            <div class="background-option" data-type="bing">
                <div class="option-preview bing-preview">
                    <i class="fas fa-image"></i>
                </div>
                <span>Bingå£çº¸</span>
            </div>
            <div class="background-option" data-type="gallery">
                <div class="option-preview gallery-preview">
                    <i class="fas fa-photos"></i>
                </div>
                <span>ç”»å»Šå›¾ç‰‡</span>
            </div>
        </div>
        <div class="background-controls">
            <div class="control-group">
                <label>èƒŒæ™¯é€æ˜åº¦</label>
                <input type="range" id="opacitySlider" min="0" max="100" value="70">
                <span id="opacityValue">70%</span>
            </div>
            <div class="control-group">
                <label>èƒŒæ™¯æ¨¡ç³Š</label>
                <input type="range" id="blurSlider" min="0" max="20" value="2">
                <span id="blurValue">2px</span>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1><i class="fas fa-images"></i> æ™ºèƒ½éšæœºå›¾ç‰‡æµè§ˆå™¨</h1>
            <p>è‡ªåŠ¨åŠ è½½ç²¾ç¾äºŒæ¬¡å…ƒå›¾ç‰‡ï¼Œäº«å—è§†è§‰ç››å®´</p>
            <p style="font-size: 0.9rem; opacity: 0.8; margin-top: 10px;">
                ğŸ¨ åŒ…å«éšæœºäºŒæ¬¡å…ƒå›¾ç‰‡ + æ¯æ—¥ç²¾é€‰Bingå£çº¸
            </p>
            <div class="stats">
                <div class="stat-item">
                    <span class="stat-number" id="loadedCount">0</span>
                    <span class="stat-label">å·²åŠ è½½</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="totalCount">3</span>
                    <span class="stat-label">å›¾ç‰‡æº</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="successRate">100%</span>
                    <span class="stat-label">æˆåŠŸç‡</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="preloadedCount">0</span>
                    <span class="stat-label">é¢„åŠ è½½</span>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="control-btn" id="autoLoadBtn">
                <i class="fas fa-play"></i>
                <span>å¼€å¯è‡ªåŠ¨åŠ è½½</span>
            </button>
            <button class="control-btn" id="refreshBtn">
                <i class="fas fa-sync-alt"></i>
                <span>åˆ·æ–°å›¾ç‰‡</span>
            </button>
            <button class="control-btn" id="clearBtn">
                <i class="fas fa-trash"></i>
                <span>æ¸…ç©ºç”»å»Š</span>
            </button>
            <button class="control-btn" id="downloadAllBtn">
                <i class="fas fa-download"></i>
                <span>æ‰¹é‡ä¸‹è½½</span>
            </button>
            <button class="control-btn" id="preloadBtn">
                <i class="fas fa-rocket"></i>
                <span>åŠ é€Ÿé¢„åŠ è½½</span>
            </button>
            <button class="control-btn" id="backgroundBtn">
                <i class="fas fa-palette"></i>
                <span>èƒŒæ™¯è®¾ç½®</span>
            </button>
        </div>

        <div class="gallery" id="gallery">
            <!-- å›¾ç‰‡å°†åŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
        </div>

        <div class="load-more-section">
            <button class="load-more-btn" id="loadMoreBtn">
                <i class="fas fa-plus"></i>
                åŠ è½½æ›´å¤šå›¾ç‰‡
            </button>
        </div>
    </div>

    <!-- è‡ªåŠ¨åŠ è½½æŒ‡ç¤ºå™¨ -->
    <div class="auto-load-indicator" id="autoLoadIndicator">
        <i class="fas fa-sync-alt fa-spin"></i>
        è‡ªåŠ¨åŠ è½½ä¸­...
    </div>

    <!-- å›¾ç‰‡æŸ¥çœ‹æ¨¡æ€æ¡† -->
    <div class="modal" id="imageModal">
        <div class="modal-content">
            <button class="modal-close" id="modalClose">&times;</button>
            <img id="modalImage" src="" alt="">
        </div>
    </div>

    <script>
        class RandomImageGallery {
            constructor() {
                this.gallery = document.getElementById('gallery');
                this.loadedCount = 0;
                this.failedCount = 0;
                this.autoLoadInterval = null;
                this.isAutoLoading = false;
                this.preloadedImages = new Map(); // é¢„åŠ è½½å›¾ç‰‡ç¼“å­˜
                this.preloadQueue = []; // é¢„åŠ è½½é˜Ÿåˆ—
                this.maxPreloadCount = 15; // æœ€å¤§é¢„åŠ è½½æ•°é‡
                this.isPreloading = false;
                this.imageAPIs = [
                    {
                        name: 'æ¨±èŠ±API',
                        url: 'https://www.dmoe.cc/random.php',
                        addTimestamp: true,
                        type: 'random'
                    },
                    {
                        name: 'EEE.DOG API',
                        url: 'https://api.yimian.xyz/img?type=moe',
                        addTimestamp: true,
                        type: 'random'
                    },
                    {
                        name: 'Bingæ¯æ—¥å£çº¸',
                        url: 'https://api.dujin.org/bing/1920.php',
                        addTimestamp: false,
                        type: 'daily',
                        loaded: false
                    }
                ];

                this.initializeEventListeners();
                this.loadInitialImages();
                this.updateStats();
                this.startPreloading(); // å¼€å§‹é¢„åŠ è½½
                
                // å»¶è¿Ÿæ£€æŸ¥å¹¶ç»‘å®šäº‹ä»¶ï¼Œç¡®ä¿åˆå§‹å›¾ç‰‡å¯ä»¥ç‚¹å‡»
                setTimeout(() => {
                    this.forceBindAllEvents();
                }, 2000);
            }

            initializeEventListeners() {
                // è‡ªåŠ¨åŠ è½½æŒ‰é’®
                document.getElementById('autoLoadBtn').addEventListener('click', () => {
                    this.toggleAutoLoad();
                });

                // åˆ·æ–°æŒ‰é’®
                document.getElementById('refreshBtn').addEventListener('click', () => {
                    this.refreshGallery();
                });

                // æ¸…ç©ºæŒ‰é’®
                document.getElementById('clearBtn').addEventListener('click', () => {
                    this.clearGallery();
                });

                // æ‰¹é‡ä¸‹è½½æŒ‰é’®
                document.getElementById('downloadAllBtn').addEventListener('click', () => {
                    this.downloadAllImages();
                });

                // åŠ é€Ÿé¢„åŠ è½½æŒ‰é’®
                document.getElementById('preloadBtn').addEventListener('click', () => {
                    this.boostPreload();
                });

                // èƒŒæ™¯è®¾ç½®æŒ‰é’®
                document.getElementById('backgroundBtn').addEventListener('click', () => {
                    this.toggleBackgroundPanel();
                });

                // èƒŒæ™¯é¢æ¿æ§åˆ¶
                document.getElementById('closePanelBtn').addEventListener('click', () => {
                    this.closeBackgroundPanel();
                });

                document.getElementById('panelBackdrop').addEventListener('click', () => {
                    this.closeBackgroundPanel();
                });

                // èƒŒæ™¯é€‰é¡¹
                document.querySelectorAll('.background-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        this.selectBackgroundType(e.currentTarget.dataset.type);
                    });
                });

                // æ»‘å—æ§åˆ¶
                document.getElementById('opacitySlider').addEventListener('input', (e) => {
                    this.updateBackgroundOpacity(e.target.value);
                });

                document.getElementById('blurSlider').addEventListener('input', (e) => {
                    this.updateBackgroundBlur(e.target.value);
                });

                // åŠ è½½æ›´å¤šæŒ‰é’®
                document.getElementById('loadMoreBtn').addEventListener('click', () => {
                    this.loadMoreImages();
                });

                // æ¨¡æ€æ¡†å…³é—­
                document.getElementById('modalClose').addEventListener('click', () => {
                    this.closeModal();
                });

                document.getElementById('imageModal').addEventListener('click', (e) => {
                    if (e.target.id === 'imageModal') {
                        this.closeModal();
                    }
                });

                // é”®ç›˜äº‹ä»¶
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeModal();
                    }
                });

                // æ»šåŠ¨åŠ è½½
                window.addEventListener('scroll', () => {
                    if (this.isAutoLoading && this.isNearBottom()) {
                        this.loadMoreImages();
                    }
                });
            }

            async loadInitialImages() {
                this.showLoadingSkeletons(6);
                await this.loadImages(6);
                this.hideLoadingSkeletons();
                
                // ç¡®ä¿åˆå§‹å›¾ç‰‡ä¹Ÿèƒ½æ­£ç¡®ç»‘å®šäº‹ä»¶
                setTimeout(() => {
                    this.refreshImageEvents();
                }, 1000);
            }

            showLoadingSkeletons(count) {
                for (let i = 0; i < count; i++) {
                    const skeleton = document.createElement('div');
                    skeleton.className = 'loading-skeleton';
                    skeleton.setAttribute('data-skeleton', 'true');
                    this.gallery.appendChild(skeleton);
                }
            }

            hideLoadingSkeletons() {
                const skeletons = this.gallery.querySelectorAll('[data-skeleton="true"]');
                skeletons.forEach(skeleton => skeleton.remove());
            }

            async loadImages(count = 3) {
                const promises = [];
                
                // é¦–æ¬¡åŠ è½½æ—¶ï¼Œå…ˆåŠ è½½Bingæ¯æ—¥å£çº¸
                const bingAPI = this.imageAPIs.find(api => api.type === 'daily');
                if (!bingAPI.loaded) {
                    promises.push(this.createImageCard(bingAPI));
                    bingAPI.loaded = true;
                    count--;
                }
                
                // å…¶ä½™ç”¨éšæœºAPIå¡«å……
                const randomAPIs = this.imageAPIs.filter(api => api.type === 'random');
                for (let i = 0; i < count; i++) {
                    const api = randomAPIs[Math.floor(Math.random() * randomAPIs.length)];
                    promises.push(this.createImageCard(api));
                }

                try {
                    await Promise.allSettled(promises);
                } catch (error) {
                    console.error('åŠ è½½å›¾ç‰‡æ—¶å‡ºé”™:', error);
                }
            }

            async createImageCard(api) {
                return new Promise((resolve) => {
                    const card = document.createElement('div');
                    card.className = 'image-card';
                    
                    const timestamp = api.addTimestamp ? `?t=${Date.now()}&r=${Math.random()}` : '';
                    const imageUrl = `${api.url}${timestamp}`;

                    card.innerHTML = `
                        <div class="image-wrapper" data-pswp-width="1920" data-pswp-height="1080">
                            <img src="${imageUrl}" alt="éšæœºå›¾ç‰‡" loading="lazy" class="gallery-image">
                            <div class="image-overlay">
                                <div class="image-actions">
                                    <button class="action-btn view-btn">
                                        <i class="fas fa-search-plus"></i>
                                        æ”¾å¤§
                                    </button>
                                    <button class="action-btn download-btn">
                                        <i class="fas fa-download"></i>
                                        ä¸‹è½½
                                    </button>
                                    <button class="action-btn refresh-btn">
                                        <i class="fas fa-sync-alt"></i>
                                        åˆ·æ–°
                                    </button>
                                    <button class="action-btn bg-btn">
                                        <i class="fas fa-paint-brush"></i>
                                        èƒŒæ™¯
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="image-info">
                            <div class="image-title">ç²¾ç¾äºŒæ¬¡å…ƒå›¾ç‰‡</div>
                            <div class="image-source">æ¥æº: ${api.name}</div>
                        </div>
                    `;
                    
                    // æ·»åŠ AOSåŠ¨ç”»
                    card.setAttribute('data-aos', 'fade-up');
                    card.setAttribute('data-aos-duration', '600');
                    card.setAttribute('data-aos-delay', Math.random() * 300);

                    const img = card.querySelector('img');
                    const viewBtn = card.querySelector('.view-btn');
                    const downloadBtn = card.querySelector('.download-btn');
                    const refreshBtn = card.querySelector('.refresh-btn');
                    const bgBtn = card.querySelector('.bg-btn');

                    // å›¾ç‰‡åŠ è½½äº‹ä»¶
                    img.onload = () => {
                        this.loadedCount++;
                        this.updateStats();
                        setTimeout(() => {
                            card.classList.add('loaded');
                            // ç¡®ä¿å›¾ç‰‡åŠ è½½å®Œæˆåå†ç»‘å®šç‚¹å‡»äº‹ä»¶
                            this.bindImageEvents(card, img, api);
                        }, Math.random() * 500);
                        resolve();
                    };

                    img.onerror = () => {
                        this.failedCount++;
                        this.updateStats();
                        
                        // ä¸ç›´æ¥åˆ é™¤ï¼Œè€Œæ˜¯å°è¯•é‡æ–°åŠ è½½æˆ–æ˜¾ç¤ºå ä½ç¬¦
                        this.handleImageError(card, img, api);
                        resolve();
                    };

                    // åŸºç¡€çš„ä¸‹è½½å’Œåˆ·æ–°æŒ‰é’®äº‹ä»¶ï¼ˆç«‹å³ç»‘å®šï¼‰
                    downloadBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.downloadImage(img.src, `image_${Date.now()}.jpg`);
                    });

                    refreshBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.refreshSingleImage(card, api);
                    });

                    bgBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.setAsBackground(img.src);
                    });
                    
                    // ä¸ºå¡ç‰‡æ·»åŠ APIç±»å‹æ ‡è¯†å’Œé‡è¯•è®¡æ•°
                    card.setAttribute('data-api-type', api.type);
                    card.setAttribute('data-retry-count', '0');
                    card.setAttribute('data-original-api', JSON.stringify(api));

                    this.gallery.appendChild(card);
                });
            }

            refreshSingleImage(card, api) {
                // å¦‚æœæ˜¯Bingæ¯æ—¥å£çº¸ï¼Œä¸å…è®¸åˆ·æ–°
                if (api.type === 'daily') {
                    alert('Bingæ¯æ—¥å£çº¸æ¯å¤©åªæœ‰ä¸€å¼ ï¼Œæ— éœ€åˆ·æ–° ğŸ˜Š');
                    return;
                }
                
                const img = card.querySelector('img');
                const sourceElement = card.querySelector('.image-source');
                
                // å°è¯•ä½¿ç”¨é¢„åŠ è½½çš„å›¾ç‰‡
                const preloadedImage = this.getPreloadedImage();
                if (preloadedImage) {
                    // ä½¿ç”¨é¢„åŠ è½½çš„å›¾ç‰‡ï¼Œç¬é—´åˆ‡æ¢
                    img.src = preloadedImage.url;
                    sourceElement.textContent = `æ¥æº: ${preloadedImage.api.name}`;
                    console.log('âš¡ å•å›¾åˆ·æ–°ï¼šä½¿ç”¨é¢„åŠ è½½å›¾ç‰‡ï¼');
                    
                    // é‡æ–°ç»‘å®šäº‹ä»¶
                    img.removeAttribute('data-events-bound');
                    this.bindImageEvents(card, img, preloadedImage.api);
                } else {
                    // å¦‚æœæ²¡æœ‰é¢„åŠ è½½å›¾ç‰‡ï¼Œåˆ™æ­£å¸¸åŠ è½½
                    const randomAPIs = this.imageAPIs.filter(api => api.type === 'random');
                    const randomApi = randomAPIs[Math.floor(Math.random() * randomAPIs.length)];
                    const timestamp = `?t=${Date.now()}&r=${Math.random()}`;
                    const newUrl = `${randomApi.url}${timestamp}`;
                    
                    card.classList.remove('loaded');
                    img.src = newUrl;
                    sourceElement.textContent = `æ¥æº: ${randomApi.name}`;
                    
                    // å›¾ç‰‡åŠ è½½å®Œæˆåæ¢å¤çŠ¶æ€å¹¶é‡æ–°ç»‘å®šäº‹ä»¶
                    img.onload = () => {
                        card.classList.add('loaded');
                        img.removeAttribute('data-events-bound');
                        this.bindImageEvents(card, img, randomApi);
                    };
                    console.log('ğŸ”„ å•å›¾åˆ·æ–°ï¼šé¢„åŠ è½½ä¸è¶³ï¼Œæ­£å¸¸åŠ è½½...');
                }
            }

            toggleAutoLoad() {
                const btn = document.getElementById('autoLoadBtn');
                const indicator = document.getElementById('autoLoadIndicator');
                
                if (this.isAutoLoading) {
                    // åœæ­¢è‡ªåŠ¨åŠ è½½
                    clearInterval(this.autoLoadInterval);
                    this.isAutoLoading = false;
                    btn.innerHTML = '<i class="fas fa-play"></i><span>å¼€å¯è‡ªåŠ¨åŠ è½½</span>';
                    btn.classList.remove('active');
                    indicator.classList.remove('show');
                } else {
                    // å¼€å§‹è‡ªåŠ¨åŠ è½½
                    this.isAutoLoading = true;
                    btn.innerHTML = '<i class="fas fa-pause"></i><span>åœæ­¢è‡ªåŠ¨åŠ è½½</span>';
                    btn.classList.add('active');
                    indicator.classList.add('show');
                    
                    this.autoLoadInterval = setInterval(() => {
                        this.loadMoreImages(2);
                    }, 5000); // æ¯5ç§’åŠ è½½2å¼ å›¾ç‰‡
                }
            }

            async loadMoreImages(count = 3) {
                const btn = document.getElementById('loadMoreBtn');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...';
                
                await this.loadImages(count);
                
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-plus"></i> åŠ è½½æ›´å¤šå›¾ç‰‡';
            }

            refreshGallery() {
                const images = this.gallery.querySelectorAll('.image-card img');
                const randomAPIs = this.imageAPIs.filter(api => api.type === 'random');
                
                images.forEach((img, index) => {
                    setTimeout(() => {
                        // è·å–å½“å‰å›¾ç‰‡çš„æ¥æºä¿¡æ¯
                        const sourceElement = img.closest('.image-card').querySelector('.image-source');
                        const currentSource = sourceElement.textContent;
                        
                        // å¦‚æœæ˜¯Bingæ¯æ—¥å£çº¸ï¼Œè·³è¿‡åˆ·æ–°
                        if (currentSource.includes('Bingæ¯æ—¥å£çº¸')) {
                            return;
                        }
                        
                        // å°è¯•ä½¿ç”¨é¢„åŠ è½½çš„å›¾ç‰‡
                        const preloadedImage = this.getPreloadedImage();
                        if (preloadedImage) {
                            // ä½¿ç”¨é¢„åŠ è½½çš„å›¾ç‰‡ï¼Œç¬é—´åˆ‡æ¢
                            img.src = preloadedImage.url;
                            sourceElement.textContent = `æ¥æº: ${preloadedImage.api.name}`;
                            console.log('âš¡ ä½¿ç”¨é¢„åŠ è½½å›¾ç‰‡ï¼Œç¬é—´åˆ‡æ¢ï¼');
                            
                            // é‡æ–°ç»‘å®šäº‹ä»¶
                            img.removeAttribute('data-events-bound');
                            this.bindImageEvents(img.closest('.image-card'), img, preloadedImage.api);
                        } else {
                            // å¦‚æœæ²¡æœ‰é¢„åŠ è½½å›¾ç‰‡ï¼Œåˆ™æ­£å¸¸åŠ è½½
                            const api = randomAPIs[Math.floor(Math.random() * randomAPIs.length)];
                            const timestamp = `?t=${Date.now()}&r=${Math.random()}&i=${index}`;
                            img.src = `${api.url}${timestamp}`;
                            sourceElement.textContent = `æ¥æº: ${api.name}`;
                            console.log('ğŸ”„ é¢„åŠ è½½å›¾ç‰‡ä¸è¶³ï¼Œæ­£å¸¸åŠ è½½...');
                            
                            // å›¾ç‰‡åŠ è½½å®Œæˆåé‡æ–°ç»‘å®šäº‹ä»¶
                            img.onload = () => {
                                img.removeAttribute('data-events-bound');
                                this.bindImageEvents(img.closest('.image-card'), img, api);
                            };
                        }
                    }, index * 50); // ç¼©çŸ­é—´éš”ï¼Œå› ä¸ºé¢„åŠ è½½å›¾ç‰‡åˆ‡æ¢æ›´å¿«
                });
            }

            clearGallery() {
                if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å›¾ç‰‡å—ï¼Ÿ')) {
                    this.gallery.innerHTML = '';
                    this.loadedCount = 0;
                    this.failedCount = 0;
                    
                    // é‡ç½®Bing APIçš„åŠ è½½çŠ¶æ€ï¼Œå…è®¸é‡æ–°åŠ è½½
                    const bingAPI = this.imageAPIs.find(api => api.type === 'daily');
                    if (bingAPI) {
                        bingAPI.loaded = false;
                    }
                    
                    this.updateStats();
                    this.loadInitialImages();
                }
            }

            async downloadAllImages() {
                const images = this.gallery.querySelectorAll('.image-card img');
                if (images.length === 0) {
                    alert('æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡');
                    return;
                }

                if (confirm(`ç¡®å®šè¦ä¸‹è½½æ‰€æœ‰ ${images.length} å¼ å›¾ç‰‡å—ï¼Ÿ`)) {
                    for (let i = 0; i < images.length; i++) {
                        setTimeout(() => {
                            this.downloadImage(images[i].src, `batch_image_${i + 1}.jpg`);
                        }, i * 500);
                    }
                }
            }

            downloadImage(url, filename) {
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            openModal(src) {
                const modal = document.getElementById('imageModal');
                const modalImage = document.getElementById('modalImage');
                modalImage.src = src;
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';
            }

            closeModal() {
                const modal = document.getElementById('imageModal');
                modal.classList.remove('show');
                document.body.style.overflow = '';
            }

            updateStats() {
                const totalCards = this.gallery.querySelectorAll('.image-card').length;
                const errorCards = this.gallery.querySelectorAll('.image-card.error').length;
                const retryingCards = this.gallery.querySelectorAll('.image-card.retrying').length;
                const successfulCards = totalCards - errorCards - retryingCards;
                
                document.getElementById('loadedCount').textContent = totalCards;
                
                const successRate = totalCards > 0 
                    ? Math.round((successfulCards / totalCards) * 100)
                    : 100;
                document.getElementById('successRate').textContent = `${successRate}%`;
                document.getElementById('preloadedCount').textContent = this.preloadedImages.size;
                
                // åœ¨æ§åˆ¶å°æ˜¾ç¤ºè¯¦ç»†ç»Ÿè®¡
                if (errorCards > 0 || retryingCards > 0) {
                    console.log(`ğŸ“Š å›¾ç‰‡çŠ¶æ€: æ€»å…±${totalCards}å¼ , æˆåŠŸ${successfulCards}å¼ , é”™è¯¯${errorCards}å¼ , é‡è¯•ä¸­${retryingCards}å¼ `);
                }
            }

            isNearBottom() {
                return window.innerHeight + window.scrollY >= document.body.offsetHeight - 1000;
            }

            // é¢„åŠ è½½ç³»ç»Ÿ
            async startPreloading() {
                if (this.isPreloading) return;
                this.isPreloading = true;
                
                // æŒç»­é¢„åŠ è½½å›¾ç‰‡
                this.preloadImages();
                
                // æ¯30ç§’è¡¥å……é¢„åŠ è½½é˜Ÿåˆ—
                setInterval(() => {
                    if (this.preloadedImages.size < this.maxPreloadCount) {
                        this.preloadImages();
                    }
                }, 30000);
            }

            async preloadImages() {
                const randomAPIs = this.imageAPIs.filter(api => api.type === 'random');
                const needCount = this.maxPreloadCount - this.preloadedImages.size;
                
                if (needCount <= 0) return;
                
                console.log(`ğŸ”„ å¼€å§‹é¢„åŠ è½½ ${needCount} å¼ å›¾ç‰‡...`);
                
                const promises = [];
                for (let i = 0; i < needCount; i++) {
                    const api = randomAPIs[Math.floor(Math.random() * randomAPIs.length)];
                    promises.push(this.preloadSingleImage(api));
                }
                
                await Promise.allSettled(promises);
                console.log(`âœ… é¢„åŠ è½½å®Œæˆï¼Œç¼“å­˜ä¸­å…±æœ‰ ${this.preloadedImages.size} å¼ å›¾ç‰‡`);
                this.updatePreloadIndicator();
            }

            async preloadSingleImage(api) {
                return new Promise((resolve) => {
                    const img = new Image();
                    const timestamp = api.addTimestamp ? `?t=${Date.now()}&r=${Math.random()}` : '';
                    const imageUrl = `${api.url}${timestamp}`;
                    
                    img.onload = () => {
                        const imageId = Date.now() + '_' + Math.random();
                        this.preloadedImages.set(imageId, {
                            url: imageUrl,
                            api: api,
                            element: img,
                            loadTime: Date.now()
                        });
                        resolve();
                    };
                    
                    img.onerror = () => {
                        resolve(); // å¤±è´¥ä¹Ÿè¦resolveï¼Œä¸é˜»å¡å…¶ä»–å›¾ç‰‡
                    };
                    
                    img.src = imageUrl;
                });
            }

            // ä»é¢„åŠ è½½ç¼“å­˜ä¸­è·å–å›¾ç‰‡
            getPreloadedImage() {
                if (this.preloadedImages.size === 0) {
                    return null;
                }
                
                // è·å–æœ€æ—©çš„é¢„åŠ è½½å›¾ç‰‡
                const firstKey = this.preloadedImages.keys().next().value;
                const imageData = this.preloadedImages.get(firstKey);
                this.preloadedImages.delete(firstKey);
                
                // æ›´æ–°é¢„åŠ è½½æŒ‡ç¤ºå™¨
                this.updatePreloadIndicator();
                
                // è§¦å‘è¡¥å……é¢„åŠ è½½
                if (this.preloadedImages.size < 5) {
                    setTimeout(() => this.preloadImages(), 1000);
                }
                
                return imageData;
            }

            // æ›´æ–°é¢„åŠ è½½æŒ‡ç¤ºå™¨
            updatePreloadIndicator() {
                this.updateStats(); // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
                
                const preloadCount = this.preloadedImages.size;
                const preloadElement = document.getElementById('preloadedCount');
                
                // æ ¹æ®é¢„åŠ è½½æ•°é‡æ”¹å˜é¢œè‰²æç¤º
                if (preloadCount >= 10) {
                    preloadElement.style.color = '#2ecc71'; // ç»¿è‰² - å……è¶³
                    console.log('ğŸ‰ é¢„åŠ è½½å……è¶³ï¼Œåˆ·æ–°ä½“éªŒå°†éå¸¸æµç•…ï¼');
                } else if (preloadCount >= 5) {
                    preloadElement.style.color = '#f39c12'; // æ©™è‰² - ä¸­ç­‰
                } else {
                    preloadElement.style.color = '#e74c3c'; // çº¢è‰² - ä¸è¶³
                }
            }

            // åŠ é€Ÿé¢„åŠ è½½
            async boostPreload() {
                const btn = document.getElementById('preloadBtn');
                const originalContent = btn.innerHTML;
                
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>åŠ é€Ÿä¸­...</span>';
                
                try {
                    // å¼ºåˆ¶é¢„åŠ è½½æ›´å¤šå›¾ç‰‡
                    this.maxPreloadCount = 25; // ä¸´æ—¶å¢åŠ é¢„åŠ è½½æ•°é‡
                    await this.preloadImages();
                    
                    // æ¢å¤æ­£å¸¸æ•°é‡
                    setTimeout(() => {
                        this.maxPreloadCount = 15;
                    }, 60000); // 1åˆ†é’Ÿåæ¢å¤
                    
                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    btn.innerHTML = '<i class="fas fa-check"></i><span>åŠ é€Ÿå®Œæˆ</span>';
                    btn.style.background = 'rgba(46, 204, 113, 0.8)';
                    
                    setTimeout(() => {
                        btn.innerHTML = originalContent;
                        btn.style.background = '';
                        btn.disabled = false;
                    }, 2000);
                    
                } catch (error) {
                    console.error('é¢„åŠ è½½åŠ é€Ÿå¤±è´¥:', error);
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                }
            }

            // èƒŒæ™¯æ§åˆ¶æ–¹æ³•
            toggleBackgroundPanel() {
                const panel = document.getElementById('backgroundPanel');
                const backdrop = document.getElementById('panelBackdrop');
                
                panel.classList.toggle('show');
                backdrop.classList.toggle('show');
            }

            closeBackgroundPanel() {
                const panel = document.getElementById('backgroundPanel');
                const backdrop = document.getElementById('panelBackdrop');
                
                panel.classList.remove('show');
                backdrop.classList.remove('show');
            }

            selectBackgroundType(type) {
                // æ›´æ–°é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.background-option').forEach(option => {
                    option.classList.remove('active');
                });
                document.querySelector(`[data-type="${type}"]`).classList.add('active');

                const backgroundLayer = document.getElementById('backgroundLayer');
                const body = document.body;

                switch(type) {
                    case 'none':
                        body.classList.add('no-background');
                        backgroundLayer.classList.remove('active');
                        console.log('ğŸ¨ å·²åˆ‡æ¢åˆ°é»˜è®¤æ¸å˜èƒŒæ™¯');
                        break;
                    
                    case 'bing':
                        body.classList.remove('no-background');
                        this.setBingBackground();
                        console.log('ğŸŒ… å·²åˆ‡æ¢åˆ°Bingæ¯æ—¥å£çº¸èƒŒæ™¯');
                        break;
                    
                    case 'gallery':
                        body.classList.remove('no-background');
                        this.setRandomGalleryBackground();
                        console.log('ğŸ² å·²åˆ‡æ¢åˆ°éšæœºç”»å»Šå›¾ç‰‡èƒŒæ™¯');
                        break;
                }
            }

            async setBingBackground() {
                const backgroundLayer = document.getElementById('backgroundLayer');
                const bingAPI = this.imageAPIs.find(api => api.type === 'daily');
                
                backgroundLayer.style.backgroundImage = `url('${bingAPI.url}')`;
                backgroundLayer.classList.add('active');
            }

            setRandomGalleryBackground() {
                const images = this.gallery.querySelectorAll('.image-card img');
                if (images.length === 0) {
                    alert('ç”»å»Šä¸­æš‚æ— å›¾ç‰‡ï¼Œè¯·å…ˆåŠ è½½ä¸€äº›å›¾ç‰‡');
                    return;
                }

                const randomImage = images[Math.floor(Math.random() * images.length)];
                this.setAsBackground(randomImage.src);
            }

            setAsBackground(imageUrl) {
                const backgroundLayer = document.getElementById('backgroundLayer');
                const body = document.body;
                
                body.classList.remove('no-background');
                backgroundLayer.style.backgroundImage = `url('${imageUrl}')`;
                backgroundLayer.classList.add('active');
                
                // æ›´æ–°èƒŒæ™¯é€‰é¡¹çŠ¶æ€
                document.querySelectorAll('.background-option').forEach(option => {
                    option.classList.remove('active');
                });
                document.querySelector('[data-type="gallery"]').classList.add('active');
                
                console.log('ğŸ–¼ï¸ å·²è®¾ç½®ä¸ºèƒŒæ™¯å›¾ç‰‡');
            }

            updateBackgroundOpacity(value) {
                const overlay = document.getElementById('backgroundOverlay');
                const opacity = (100 - value) / 100;
                overlay.style.background = `rgba(0, 0, 0, ${opacity * 0.5})`;
                document.getElementById('opacityValue').textContent = `${value}%`;
            }

            updateBackgroundBlur(value) {
                const overlay = document.getElementById('backgroundOverlay');
                overlay.style.backdropFilter = `blur(${value}px)`;
                document.getElementById('blurValue').textContent = `${value}px`;
            }

            // PhotoSwipe å›¾ç‰‡æ”¾å¤§åŠŸèƒ½
            openPhotoSwipe(imageSrc, card) {
                // åˆ›å»º PhotoSwipe æ•°æ®æº
                const items = [{
                    src: imageSrc,
                    width: 1920,
                    height: 1080,
                    alt: 'ç²¾ç¾å›¾ç‰‡'
                }];

                // å¯¼å…¥å¹¶åˆå§‹åŒ– PhotoSwipe
                import('https://cdn.jsdelivr.net/npm/photoswipe@5.4.2/dist/photoswipe.esm.js')
                    .then(({ default: PhotoSwipe }) => {
                        const lightbox = new PhotoSwipe({
                            dataSource: items,
                            index: 0,
                            bgOpacity: 0.9,
                            showHideAnimationType: 'zoom',
                            imageClickAction: 'close',
                            tapAction: 'close',
                            doubleTapAction: 'zoom',
                            preloaderDelay: 500,
                            closeTitle: 'å…³é—­ (Esc)',
                            zoomTitle: 'ç¼©æ”¾',
                            arrowPrevTitle: 'ä¸Šä¸€å¼ ',
                            arrowNextTitle: 'ä¸‹ä¸€å¼ ',
                            errorMsg: 'å›¾ç‰‡åŠ è½½å¤±è´¥'
                        });

                        lightbox.init();
                        lightbox.loadAndOpen(0);
                        
                        console.log('ğŸ” PhotoSwipe å·²æ‰“å¼€å›¾ç‰‡æŸ¥çœ‹å™¨');
                    })
                    .catch(error => {
                        console.error('PhotoSwipe åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ¨¡æ€æ¡†:', error);
                        this.openModal(imageSrc);
                    });
            }

            // ç»‘å®šå›¾ç‰‡ç›¸å…³äº‹ä»¶
            bindImageEvents(card, img, api) {
                const viewBtn = card.querySelector('.view-btn');
                
                // é˜²æ­¢é‡å¤ç»‘å®š
                if (img.hasAttribute('data-events-bound')) {
                    return;
                }
                
                // æ”¾å¤§æŸ¥çœ‹æŒ‰é’® - ä½¿ç”¨PhotoSwipe
                if (viewBtn) {
                    viewBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.openPhotoSwipe(img.src, card);
                    });
                }

                // å›¾ç‰‡ç‚¹å‡»äº‹ä»¶ - ä¹Ÿæ”¯æŒæ”¾å¤§æŸ¥çœ‹
                img.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.openPhotoSwipe(img.src, card);
                });

                // æ ‡è®°äº‹ä»¶å·²ç»‘å®š
                img.setAttribute('data-events-bound', 'true');
                console.log('ğŸ”— å›¾ç‰‡äº‹ä»¶å·²ç»‘å®š:', img.src.substring(0, 50) + '...');
            }

            // åˆ·æ–°æ‰€æœ‰å›¾ç‰‡çš„äº‹ä»¶ç»‘å®š
            refreshImageEvents() {
                const images = this.gallery.querySelectorAll('.image-card');
                images.forEach(card => {
                    const img = card.querySelector('img');
                    const api = this.imageAPIs.find(apiItem => 
                        card.querySelector('.image-source').textContent.includes(apiItem.name)
                    ) || this.imageAPIs[0];
                    
                    if (img && img.complete && img.naturalHeight !== 0) {
                        this.bindImageEvents(card, img, api);
                    }
                });
                console.log('ğŸ”„ å·²åˆ·æ–°æ‰€æœ‰å›¾ç‰‡äº‹ä»¶ç»‘å®š');
            }

            // å¼ºåˆ¶ç»‘å®šæ‰€æœ‰å›¾ç‰‡äº‹ä»¶ï¼ˆä¿®å¤åˆå§‹åŠ è½½é—®é¢˜ï¼‰
            forceBindAllEvents() {
                const images = this.gallery.querySelectorAll('.image-card img');
                console.log(`ğŸ”§ å¼ºåˆ¶æ£€æŸ¥ ${images.length} å¼ å›¾ç‰‡çš„äº‹ä»¶ç»‘å®š...`);
                
                images.forEach((img, index) => {
                    if (!img.hasAttribute('data-events-bound')) {
                        const card = img.closest('.image-card');
                        const sourceElement = card.querySelector('.image-source');
                        const sourceName = sourceElement ? sourceElement.textContent : '';
                        
                        // æ ¹æ®æ¥æºä¿¡æ¯æ‰¾åˆ°å¯¹åº”çš„API
                        const api = this.imageAPIs.find(apiItem => 
                            sourceName.includes(apiItem.name)
                        ) || this.imageAPIs[0];
                        
                        // å¼ºåˆ¶ç»‘å®šäº‹ä»¶
                        this.bindImageEvents(card, img, api);
                        console.log(`âœ… ä¿®å¤ç¬¬ ${index + 1} å¼ å›¾ç‰‡çš„äº‹ä»¶ç»‘å®š`);
                    }
                });
                
                console.log('ğŸ‰ æ‰€æœ‰å›¾ç‰‡äº‹ä»¶ç»‘å®šæ£€æŸ¥å®Œæˆï¼');
            }

            // å¤„ç†å›¾ç‰‡åŠ è½½é”™è¯¯
            handleImageError(card, img, api) {
                const retryCount = parseInt(card.getAttribute('data-retry-count') || '0');
                const maxRetries = 3;
                
                console.log(`âŒ å›¾ç‰‡åŠ è½½å¤±è´¥: ${img.src.substring(0, 50)}...ï¼Œé‡è¯•æ¬¡æ•°: ${retryCount}/${maxRetries}`);
                
                if (retryCount < maxRetries) {
                    // è¿˜å¯ä»¥é‡è¯•
                    this.retryImageLoad(card, img, api, retryCount);
                } else {
                    // è¶…è¿‡é‡è¯•æ¬¡æ•°ï¼Œæ˜¾ç¤ºé”™è¯¯å ä½ç¬¦
                    this.showErrorPlaceholder(card, api);
                }
            }

            // é‡è¯•åŠ è½½å›¾ç‰‡
            async retryImageLoad(card, img, api, currentRetryCount) {
                const newRetryCount = currentRetryCount + 1;
                card.setAttribute('data-retry-count', newRetryCount.toString());
                card.classList.add('retrying');
                
                // ç­‰å¾…ä¸€æ®µæ—¶é—´å†é‡è¯•
                await new Promise(resolve => setTimeout(resolve, 1000 * newRetryCount));
                
                // å°è¯•ä½¿ç”¨é¢„åŠ è½½çš„å›¾ç‰‡
                const preloadedImage = this.getPreloadedImage();
                if (preloadedImage) {
                    console.log(`ğŸ”„ ç¬¬${newRetryCount}æ¬¡é‡è¯•ï¼šä½¿ç”¨é¢„åŠ è½½å›¾ç‰‡`);
                    img.src = preloadedImage.url;
                    card.querySelector('.image-source').textContent = `æ¥æº: ${preloadedImage.api.name}`;
                    card.classList.remove('retrying');
                    
                    // é‡æ–°ç»‘å®šäº‹ä»¶
                    img.removeAttribute('data-events-bound');
                    this.bindImageEvents(card, img, preloadedImage.api);
                } else {
                    // å°è¯•æ¢ä¸€ä¸ªAPIæˆ–ä½¿ç”¨æ—¶é—´æˆ³å¼ºåˆ¶åˆ·æ–°
                    const randomAPIs = this.imageAPIs.filter(apiItem => apiItem.type === 'random');
                    const newApi = randomAPIs[Math.floor(Math.random() * randomAPIs.length)];
                    const timestamp = `?retry=${newRetryCount}&t=${Date.now()}&r=${Math.random()}`;
                    const newUrl = `${newApi.url}${timestamp}`;
                    
                    console.log(`ğŸ”„ ç¬¬${newRetryCount}æ¬¡é‡è¯•ï¼šåˆ‡æ¢API ${newApi.name}`);
                    img.src = newUrl;
                    card.querySelector('.image-source').textContent = `æ¥æº: ${newApi.name} (é‡è¯•${newRetryCount})`;
                }
            }

            // æ˜¾ç¤ºé”™è¯¯å ä½ç¬¦
            showErrorPlaceholder(card, api) {
                console.log('ğŸ’¥ å›¾ç‰‡åŠ è½½å½»åº•å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯å ä½ç¬¦');
                
                card.classList.remove('retrying');
                card.classList.add('error');
                
                const imageWrapper = card.querySelector('.image-wrapper');
                imageWrapper.innerHTML = `
                    <div class="error-placeholder">
                        <i class="fas fa-image-slash"></i>
                        <div class="error-message">å›¾ç‰‡åŠ è½½å¤±è´¥</div>
                        <div style="font-size: 0.8rem; opacity: 0.7; margin-bottom: 15px;">
                            API: ${api.name}
                        </div>
                        <button class="retry-button" onclick="this.closest('.image-card').retryLoad()">
                            <i class="fas fa-redo"></i> é‡æ–°å°è¯•
                        </button>
                    </div>
                `;
                
                // ä¸ºå¡ç‰‡æ·»åŠ é‡æ–°åŠ è½½æ–¹æ³•
                card.retryLoad = () => {
                    this.retryFailedImage(card, api);
                };
                
                // æ›´æ–°å›¾ç‰‡ä¿¡æ¯
                const imageInfo = card.querySelector('.image-info');
                imageInfo.innerHTML = `
                    <div class="image-title" style="color: #e74c3c;">åŠ è½½å¤±è´¥</div>
                    <div class="image-source">æ¥æº: ${api.name}</div>
                `;
            }

            // é‡æ–°å°è¯•åŠ è½½å¤±è´¥çš„å›¾ç‰‡
            async retryFailedImage(card, api) {
                console.log('ğŸ”„ ç”¨æˆ·æ‰‹åŠ¨é‡è¯•åŠ è½½å›¾ç‰‡');
                
                const retryButton = card.querySelector('.retry-button');
                retryButton.disabled = true;
                retryButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> é‡è¯•ä¸­...';
                
                // é‡ç½®é‡è¯•è®¡æ•°
                card.setAttribute('data-retry-count', '0');
                card.classList.remove('error');
                card.classList.add('retrying');
                
                // å°è¯•ä½¿ç”¨é¢„åŠ è½½å›¾ç‰‡æˆ–æ–°çš„éšæœºå›¾ç‰‡
                const preloadedImage = this.getPreloadedImage();
                if (preloadedImage) {
                    this.replaceFailedImage(card, preloadedImage.url, preloadedImage.api);
                } else {
                    // ä½¿ç”¨æ–°çš„éšæœºAPI
                    const randomAPIs = this.imageAPIs.filter(apiItem => apiItem.type === 'random');
                    const newApi = randomAPIs[Math.floor(Math.random() * randomAPIs.length)];
                    const timestamp = `?manual_retry=${Date.now()}&r=${Math.random()}`;
                    const newUrl = `${newApi.url}${timestamp}`;
                    
                    this.replaceFailedImage(card, newUrl, newApi);
                }
            }

            // æ›¿æ¢å¤±è´¥çš„å›¾ç‰‡
            replaceFailedImage(card, newImageUrl, newApi) {
                const imageWrapper = card.querySelector('.image-wrapper');
                
                imageWrapper.innerHTML = `
                    <img src="${newImageUrl}" alt="éšæœºå›¾ç‰‡" loading="lazy" class="gallery-image">
                    <div class="image-overlay">
                        <div class="image-actions">
                            <button class="action-btn view-btn">
                                <i class="fas fa-search-plus"></i>
                                æ”¾å¤§
                            </button>
                            <button class="action-btn download-btn">
                                <i class="fas fa-download"></i>
                                ä¸‹è½½
                            </button>
                            <button class="action-btn refresh-btn">
                                <i class="fas fa-sync-alt"></i>
                                åˆ·æ–°
                            </button>
                            <button class="action-btn bg-btn">
                                <i class="fas fa-paint-brush"></i>
                                èƒŒæ™¯
                            </button>
                        </div>
                    </div>
                `;
                
                const img = imageWrapper.querySelector('img');
                const sourceElement = card.querySelector('.image-source');
                
                img.onload = () => {
                    card.classList.remove('retrying', 'error');
                    card.classList.add('loaded');
                    sourceElement.textContent = `æ¥æº: ${newApi.name}`;
                    
                    // é‡æ–°ç»‘å®šæ‰€æœ‰äº‹ä»¶
                    this.bindImageEvents(card, img, newApi);
                    this.bindBasicButtonEvents(card, img, newApi);
                    
                    console.log('âœ… å›¾ç‰‡é‡æ–°åŠ è½½æˆåŠŸï¼');
                };
                
                img.onerror = () => {
                    console.log('âŒ é‡æ–°åŠ è½½ä»ç„¶å¤±è´¥');
                    this.showErrorPlaceholder(card, newApi);
                };
                
                // æ›´æ–°å›¾ç‰‡ä¿¡æ¯
                const imageInfo = card.querySelector('.image-info');
                imageInfo.innerHTML = `
                    <div class="image-title">ç²¾ç¾äºŒæ¬¡å…ƒå›¾ç‰‡</div>
                    <div class="image-source">æ¥æº: ${newApi.name}</div>
                `;
            }

            // ç»‘å®šåŸºç¡€æŒ‰é’®äº‹ä»¶
            bindBasicButtonEvents(card, img, api) {
                const downloadBtn = card.querySelector('.download-btn');
                const refreshBtn = card.querySelector('.refresh-btn');
                const bgBtn = card.querySelector('.bg-btn');
                
                if (downloadBtn) {
                    downloadBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.downloadImage(img.src, `image_${Date.now()}.jpg`);
                    });
                }
                
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.refreshSingleImage(card, api);
                    });
                }
                
                if (bgBtn) {
                    bgBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.setAsBackground(img.src);
                    });
                }
            }
        }

        // åˆå§‹åŒ–ç”»å»Š
        document.addEventListener('DOMContentLoaded', () => {
            new RandomImageGallery();
            
            // åˆå§‹åŒ–AOSåŠ¨ç”»
            import('https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js')
                .then(({ default: AOS }) => {
                    AOS.init({
                        duration: 800,
                        easing: 'ease-out-cubic',
                        once: false,
                        offset: 50
                    });
                    console.log('âœ¨ AOS åŠ¨ç”»ç³»ç»Ÿå·²åˆå§‹åŒ–');
                })
                .catch(error => {
                    console.warn('AOS åŠ è½½å¤±è´¥:', error);
                });
        });
    </script>

    <!-- Gwozai Brand Component -->
    <div class="gwozai-brand">
        <div class="gwozai-logo">
            <span class="gwozai-text">gwozai</span>
            <span class="gwozai-dot">.</span>
            <span class="gwozai-tech">tech</span>
        </div>
        <div class="gwozai-tagline">æ‰“é€ å®ç”¨å·¥å…·é›†</div>
    </div>

    <style>
        .gwozai-brand {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 12px 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            cursor: pointer;
            user-select: none;
        }

        .gwozai-brand:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            background: rgba(255, 255, 255, 1);
        }

        .gwozai-logo {
            display: flex;
            align-items: center;
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 700;
            font-size: 16px;
            line-height: 1;
            margin-bottom: 2px;
        }

        .gwozai-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
        }

        .gwozai-dot {
            color: #ff6b6b;
            margin: 0 1px;
        }

        .gwozai-tech {
            color: #4ecdc4;
        }

        .gwozai-tagline {
            font-size: 10px;
            color: #666;
            text-align: center;
            font-weight: 500;
            opacity: 0.8;
        }

        @media (max-width: 768px) {
            .gwozai-brand {
                bottom: 15px;
                right: 15px;
                padding: 10px 12px;
            }
            
            .gwozai-logo {
                font-size: 14px;
            }
            
            .gwozai-tagline {
                font-size: 9px;
            }
        }

        @media (prefers-color-scheme: dark) {
            .gwozai-brand {
                background: rgba(30, 30, 30, 0.95);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .gwozai-brand:hover {
                background: rgba(40, 40, 40, 1);
            }
            
            .gwozai-tagline {
                color: #aaa;
            }
        }
    </style>

    <script>
        document.querySelector('.gwozai-brand').addEventListener('click', function() {
            const currentPath = window.location.pathname;
            const pathSegments = currentPath.split('/');
            
            let homePath = '/';
            if (pathSegments.includes('tools')) {
                homePath = '../../index.html';
            } else if (pathSegments.includes('pages')) {
                homePath = '../index.html';
            }
            
            window.location.href = homePath;
        });
    </script>
</body>
</html>